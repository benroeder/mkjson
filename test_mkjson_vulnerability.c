#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "mkjson.h"

void verify_json(const char* json, const char* test_name) {
    printf("JSON validity: ");
    
    // Basic JSON structure check
    if (!json || strlen(json) < 2) {
        printf("INVALID (too short)\n");
        return;
    }
    
    if ((json[0] != '{' && json[0] != '[') || 
        (json[strlen(json)-1] != '}' && json[strlen(json)-1] != ']')) {
        printf("INVALID (bad brackets)\n");
        return;
    }
    
    // Check for unescaped quotes
    int in_string = 0;
    int escaped = 0;
    for (const char* p = json + 1; p < json + strlen(json) - 1; p++) {
        if (escaped) {
            escaped = 0;
            continue;
        }
        if (*p == '\\') {
            escaped = 1;
            continue;
        }
        if (*p == '"') {
            in_string = !in_string;
        }
    }
    
    if (in_string) {
        printf("INVALID (unclosed string)\n");
    } else {
        printf("VALID\n");
    }
}

int main() {
    printf("Testing mkjson string escaping security fixes:\n\n");
    
    // Test 1: String with quotes
    char* json1 = mkjson(MKJSON_OBJ, 1,
        MKJSON_STRING, "name", "foo\"bar"
    );
    printf("Test 1 - String with quotes:\n");
    printf("Input: foo\"bar\n");
    printf("Output: %s\n", json1);
    printf("Expected: {\"name\": \"foo\\\"bar\"}\n");
    verify_json(json1, "Test 1");
    printf("FIXED: %s\n\n", strstr(json1, "foo\\\"bar") ? "YES" : "NO");
    free(json1);
    
    // Test 2: String with newline
    char* json2 = mkjson(MKJSON_OBJ, 1,
        MKJSON_STRING, "text", "line1\nline2"
    );
    printf("Test 2 - String with newline:\n");
    printf("Input: line1\\nline2\n");
    printf("Output: %s\n", json2);
    printf("Expected: {\"text\": \"line1\\nline2\"}\n");
    verify_json(json2, "Test 2");
    printf("FIXED: %s\n\n", strstr(json2, "\\n") ? "YES" : "NO");
    free(json2);
    
    // Test 3: Key with quotes
    char* json3 = mkjson(MKJSON_OBJ, 1,
        MKJSON_STRING, "foo\"bar", "value"
    );
    printf("Test 3 - Key with quotes:\n");
    printf("Input key: foo\"bar\n");
    printf("Output: %s\n", json3);
    printf("Expected: {\"foo\\\"bar\": \"value\"}\n");
    verify_json(json3, "Test 3");
    printf("FIXED: %s\n\n", strstr(json3, "foo\\\"bar") ? "YES" : "NO");
    free(json3);
    
    // Test 4: Backslash
    char* json4 = mkjson(MKJSON_OBJ, 1,
        MKJSON_STRING, "path", "C:\\Users\\test"
    );
    printf("Test 4 - String with backslashes:\n");
    printf("Input: C:\\Users\\test\n");
    printf("Output: %s\n", json4);
    printf("Expected: {\"path\": \"C:\\\\Users\\\\test\"}\n");
    verify_json(json4, "Test 4");
    printf("FIXED: %s\n\n", strstr(json4, "C\\\\\\\\Users\\\\\\\\test") ? "YES" : "NO");
    free(json4);
    
    // Test 5: Control characters
    char* json5 = mkjson(MKJSON_OBJ, 1,
        MKJSON_STRING, "data", "Hello\x01\x02\x03World"
    );
    printf("Test 5 - Control characters:\n");
    printf("Input: Hello\\x01\\x02\\x03World\n");
    printf("Output: %s\n", json5);
    printf("Expected: {\"data\": \"Hello\\u0001\\u0002\\u0003World\"}\n");
    verify_json(json5, "Test 5");
    free(json5);
    
    // Test 6: Mixed special characters
    char* json6 = mkjson(MKJSON_OBJ, 1,
        MKJSON_STRING, "msg", "Line 1\n\tIndented\r\nLine 2 \"quoted\""
    );
    printf("\nTest 6 - Mixed special characters:\n");
    printf("Input: Line 1\\n\\tIndented\\r\\nLine 2 \"quoted\"\n");
    printf("Output: %s\n", json6);
    verify_json(json6, "Test 6");
    free(json6);
    
    return 0;
}